{%- extends "layout.html" %}
{%- block content %}

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
    
        var x = $('#rmid').val();
        // console.log('ここ',x);

        var socket_emi = io.connect('https://sample301-20210223.herokuapp.com');
        var socket = io.connect('https://sample301-20210223.herokuapp.com'+'/'+x);
        
        $('#enter').on('click', function() {
            var value = $('#enter').val();
            console.log('確認1');
            socket_emi.emit("joins", value);
        });

        socket.on('message', function(msg) {
            $("#messages").append('<li>'+msg+'</li>');
            console.log('Received message');
        });
                
        $('#sendbutton').on('click', function() {
            var roomname = '/'+$('#rmid').val();
            socket.send($('#myMessage').val(), roomname);
            $('#myMessage').val('');
        });



        // グラフ
        $(document).on('click', '#views',function(event){
            event.preventDefault();
            var sign_pre = $(this).attr('name');
            console.log(sign_pre);
            // var id_pre = id_pre.split(',');
            // var id = '#' + id_pre[0];

            $.ajax(
                {
                type : 'post',
                url : '/own_ajax',
                data : {sign : sign_pre},
                dataType: 'json',
                success: function(response){
                    $('#views').html(response['form'])
                    console.log($('#text_id').html(response['form']));
                },
                error: function(rs, e){
                    console.log(rs.responseText);
                }
            })
            .done(function(data){
                // $(view).text(data.output).show();



                if (data.output[0]=="score"){
                 
                  google.charts.load('current', {'packages':['corechart']});
                  google.charts.setOnLoadCallback(drawChart);
                  
                  grp_datas = [['Date', 'Score']]
                  for (let i=0; i<data.output[1].length; i++){
                    grp_datas.push(data.output[1][i]);
                  }

                  function drawChart() {
                    var data = google.visualization.arrayToDataTable(
                      grp_datas
                    );

                    var options = {
                      title: 'Mind Score',
                      curveType: 'function',
                      legend: { position: 'bottom' }
                    };

                    var chart = new google.visualization.LineChart(document.getElementById('viewing'));

                    chart.draw(data, options);
                  }



                }else if (data.output[0]=="personality"){
                  $(viewing).text(data.output[1]).show();



                }else if (data.output[0]=="endgtask"){
                  $('#viewing').html(data.output[1].replace(/\n/g, '<br>'));


                }else if (data.output[0]=="bbsontxt"){
                  $('#viewing').html(data.output[1].replace(/\n/g, '<br>'));



                }else if (data.output[0]=="bbsonact"){
                  $('#viewing').html(data.output[1].replace(/\n/g, '<br>'));

                };
            });
        });

    });
</script>



<div class="large" style='margin-top: 30px;'>
    <div class="text-center">

      {% if roomsign == 0 %}

      {% if (rooms|length) > 0 %}

          {% for num in range(1,rooms[0]) %}
            <form action="/own_p" method="POST">
              <button id="enter" value="{{ rooms[num] }}" name={{num}} class="button" type="submit">{{ rooms[num] }},{{ num }}</button>
            </form>
          {% endfor %}
      
      {% else %}

        <p>user is nothing</p>

      {% endif %}

      {% elif roomsign == 1 %}
          <input id="rmid" value="{{ rooms }}" style="display: none;">

          <ul id="messages"></ul>
          {{ form.csrf_token }}
          {{ form.twmc_txt(size=20, id="myMessage") }}
          <input id="rn" value="{{ roomname }}" style="display: none;"></p>
          <button id="sendbutton" style="background-color: lightblue;">Send</button>
          

          <!-- <p>input your name</p>
          {{ form.csrf_token }}
          {{ form.twmc_room(size=20, id="twmc_rn") }}
          <button id="choice">ok</button> -->

          <div class="large" style='margin-top: 30px;'>
              <div class="text-center">
              {% for error in form.twmc_txt.errors %}
              <p style="color: orange;">{{ error }}</p>
              {% endfor %}
              </div>
          </div>

          <div style="margin-top: 30px;">
            <ul>
                <li style="display: inline;"><button id="views" name="graph" class="hollow button secondary" style="color:rgb(81, 163, 196); background-color: rgb(227, 251, 253);">graph</button></li>
                <li style="display: inline;"><button id="views" name="personality" class="hollow button secondary" style="color:rgb(81, 163, 196); background-color: rgb(227, 251, 253);">personality</button></li>
                <li style="display: inline;"><button id="views" name="endgtask" class="hollow button secondary" style="color:rgb(81, 163, 196); background-color: rgb(227, 251, 253);">end goal and tasks</button></li>
                <li style="display: inline;"><button id="views" name="bbsontxt" class="hollow button secondary" style="color:rgb(81, 163, 196); background-color: rgb(227, 251, 253);">bbs on text</button></li>
                <li style="display: inline;"><button id="views" name="bbsonact" class="hollow button secondary" style="color:rgb(81, 163, 196); background-color: rgb(227, 251, 253);">bbs on act</button></li>
            </ul>

            <div id="viewing" style="width: 400px; height: 200px"></div>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
        </div>


      {% endif %}
    </div>
  </div>
{%- endblock %}